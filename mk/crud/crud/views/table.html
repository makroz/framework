
{% append style.inline %}
.highlight{
  background-color:#000;
}
.input-field .postfix {
    font-size: 2rem;
    position: absolute;
    right:0;
    transition: color 0.2s ease 0s;
    width: 3rem;
}
.input-field .postfix.active {
color:#26a69a;
}

.portlet-placeholder {
    border: 1px dotted black;
    margin: 0 1em 1em 0;
    height: 50px;
  }

.input-field .postfix ~ input, .input-field .postfix ~ textarea, .input-field .postfix ~ label, .input-field .postfix ~ .validate ~ label, .input-field .postfix ~ .autocomplete-content {
    margin-rigth: 3rem;
    width: calc(100% - 3rem);
}
{% /append %}


{% append js.files %}
<link href='js/jquery-ui/jquery-ui.min.css' rel='stylesheet'>
<script type='text/javascript' src='js/jquery-ui/jquery-ui.min.js'></script>
{% /append %}

{% append js.onready %}

$(".button-collapse").sideNav();
$('select').material_select();

$('#funcion').bind( "change", function() {  
  valFuncion(); 
});

$(' #tipolista').bind( "change", function() {  
  valTipoLista(); 
});

$('#usof').bind( "change", function() {  
  valUsof(); 
});

$('.campojoin > i').click(function() {
  openJoin('campojoin');
});

$('.listalista > i').click(function() {
  openLista(modalistalista);
});

$('.listaeventos > i').click(function() {
  openLista(modalistaeventos);
});

 $("#campos").sortable({
   containment: "#campos",
    cursor: "move",
    forceHelperSize: true,
    handle: ".handle",
    opacity: 0.5,
});

$("#modal1").modal();

{% /append %}

{% append js.inline %}

function cargarConfig(){
  var plantilla=prompt('Ingrese la Plantilla:','');
  if (plantilla!=''){

    var datos=JSON.parse(plantilla);
  
  $.each(datos, function(i, item) {
    if (i=='field'){
      $.each(item, function(i1,item1){
        if (jQuery.type(item1)=='object'){
          $.each(item1, function(i2,item2){
           // alert('#'+i+'-'+i1+'-'+i2+':'+$('#'+i+'-'+i1+'-'+i2).val());
            $('#'+i+'-'+i1+'-'+i2).val(item2);      
           // alert('#'+i+'-'+i1+'-'+i2+':'+$('#'+i+'-'+i1+'-'+i2).val());
          });
        }
      });
    }else{
      if (jQuery.type(item)=='string'){
        $('#'+i+'.plantilla').val(item);  
      }
    }
  });
  
  }

  $('select').material_select();
   Materialize.updateTextFields();
  
}


function openDet(id){
  $('#modal1').attr('data-key',id);
  $('#modal-tit').html("Detalles del Campo: <span class='red-text'>"+id);
  $('._pedir').each(function() {

    if ( ($(this).attr('data-type')=='text')||($(this).attr('data-type')=='sel')||($(this).attr('data-type')=='range') ){
      $(this).val($('#field-'+id+'-'+$(this).attr('id')).val());  
    }

    if ( ($(this).attr('data-type')=='switch')||($(this).attr('data-type')=='check') ){
        
      if ($('#field-'+id+'-'+$(this).attr('id')).val()==$(this).attr('data-on')){

        this.checked=true;  
      }else{
        this.checked=false;  
      }
    }
  });


  $('select').material_select();
  $('#modal1').modal('open');
  valFunc();
  Materialize.updateTextFields();
  return false;
}



function valFunc(){
  valUsof();
  valTipoLista();
  valFuncion();
}

function closeDet(){
  var id=$('#modal1').attr('data-key');

 $('._pedir').each(function() {

    if ( ($(this).attr('data-type')=='text')||($(this).attr('data-type')=='sel')||($(this).attr('data-type')=='range') ){
      $('#field-'+id+'-'+$(this).attr('id')).val($(this).val())
    }

    if ( ($(this).attr('data-type')=='switch')||($(this).attr('data-type')=='check')  ){
      if ($(this).is(':checked')){
        $('#field-'+id+'-'+$(this).attr('id')).val($(this).attr('data-on'));
      }else{
        $('#field-'+id+'-'+$(this).attr('id')).val($(this).attr('data-off'));
      }
      
    }

  
  });


  $('#modal1').modal('close');
}


function valUsof(){

  $('#funcion').removeAttr('disabled');

  valor=$('#usof').val();
  $('.usof').removeClass('s8').addClass('s12');
  $('.tam , .posf').hide();
 
  if ((valor!='-1')&&(valor!='oculto')&&(valor.trim()!='')){
    $('.usof').removeClass('s12').addClass('s8');
    $('.tam, .posf').show();
  }
 
  if (valor=='check'){
    $('#funcion').val('check').attr('disabled','disabled');
    $('#tipolista').val('check');
    valFuncion();
    valTipoLista();
  }

 if (valor=='float'){
    $('#funcion').val('bdf');
    valFuncion();
  }
  $('select').material_select();

}

function valFuncion(){


  var valor=$('#funcion').val();
  $('.funcion').removeClass('s10').addClass('s12');
  $('.dec, .fcustom, .checkvalor').hide();

  if (valor=='bdf'){
    $('.funcion').removeClass('s12').addClass('s10');
    $('.dec').show();
  }

   if (valor=='check'){
    $('.funcion').removeClass('s12').addClass('s10');
    $('.checkvalor').show();
  }
 
  if (valor=='custom'){
    $('.funcion').removeClass('s12').addClass('s10');
    $('.fcustom').show();
  }

}

function valTipoLista(){
  valor=$('#tipolista').val();
  $('.tipolista').removeClass('s6, s12').addClass('s9');
  $('.campojoin,  .checklista, .listalista').hide();
   $('.tamlista').show();

  if ((valor=='get')||(valor=='-1')){ 
    $('.tipolista').removeClass('s6, s9').addClass('s12');
    $('.tamlista').hide();
  }
 
  if (valor=='join'){
    $('.tipolista').removeClass('s12, s9').addClass('s6');
    $('.campojoin').show();
  }

  if (valor=='lista'){
    $('.tipolista').removeClass('s12, s9').addClass('s6');
    $('.listalista').show();
  }

  if (valor=='check'){
    $('.tipolista').removeClass('s12, s9').addClass('s6');
    $('.checklista').show();
  }


  
}

function validarFormulario(){
  $('#form1').submit();  
}


function clicChecked(id){
  return false;
}


function openJoin(id){
  $('#modal2').modal();
  $('#modal2').attr('data-key',id);
  var dato=$('#campojoin').val();
  if (dato==''){
    $('#n_table, #n_col').val(-1);
  }else{
    var datos=dato.split('.');
    $('#n_table').val(datos[0]);
    getCampos(datos[1]);
  }
  $('#modal2').modal('open');
  $('select').material_select();
}

function getCampos(valTarget){
  var dato=getSelAjax('#n_table',
      'index.php?crud=getCampos',
      '#n_col',
      valTarget
    );
}

function closeJoin(){
  var id=$('#modal2').attr('data-key');
  var dato=$('#n_table').val()+'.'+$('#n_col').val();
  $('#'+id).val( dato );

  Materialize.updateTextFields();
  $('#modal2').modal('close');
}

var modalista=[];
modalista['modal']='';
modalista['campo']='';
modalista['addTr']='';
modalista['tit']='';
modalista['head']='';
var modalistalista=[];
modalistalista['modal']='#modalLista';
modalistalista['campo']='#listalista';
modalistalista['addTr']='addTrListalista';
modalistalista['tit']='Crear Lista';
modalistalista['head']='<tr><th data-field="valor">VALOR</th><th data-field="texto">TEXTO</th><th data-field="tag">TAGS</th><th data-field="action">Accion</th></tr>';
var modalistaeventos=[];
modalistaeventos['modal']='#modalLista';
modalistaeventos['campo']='#listaeventos';
modalistaeventos['addTr']='addTrListaeventos';
modalistaeventos['tit']='Lista de Eventos';
modalistaeventos['head']='<tr><th data-field="evento">EVENTO</th><th data-field="codigo">CODIGO</th><th data-field="action">Accion</th></tr>';


function openLista(objeto){
  if (!objeto){
    objeto=modalistalista;
  }
  modalista=objeto;
  var modal=modalista['modal'];
  var campo=modalista['campo'];
  $(modal).find('h4').html(modalista['tit']);
  $(modal+' thead').html(modalista['head']);

  $(modal).modal();
  //$(modal).attr('data-key',id);

  var datos=$(campo).val()+'*';
  var tr=datos.split('*');
  $(modal+' tbody tr').remove();
  for (i = 0; i < tr.length; i++) {
    if (tr[i]!=''){
      var dato=(tr[i]).split('|');
      _addTr(i+1,dato);
    }
  }

  $(modal).find('#bAddLista').data('indice',tr.length);

  $(modal).modal('open');
  $('select').material_select();
  $(modal).find("#tablalista tbody").sortable({
    axis:'y',
    containment: "parent",
    cursor: "move",
    forceHelperSize: true,
    handle: ".handle",
    opacity: 0.5
  });
}

function cAdd(){
  var modal=modalista['modal'];
  var campo=modalista['campo'];

  var dato=0;
  dato= $(modal).find('#bAddLista').data('indice');
  if (dato=='-1'){
    dato= $(modal).find('#tablalista tbody tr').length;
  }
  dato=dato+1;
  $(modal).find('#bAddLista').data('indice',dato);

  _addTr(dato,['','','']);
}


function cDel(id){
  var modal=modalista['modal'];
  $(modal).find('#trlista'+id).remove();
}

function cSaveLista(){
  var modal=modalista['modal'];
  var campo=modalista['campo'];
  var dato='';

  $(modal).find('#tablalista tbody tr').each(function( index ) {
    var i=$( this ).data('i');
    
    $(modal).find('.dato'+i).each(function( index ) {
      if ($( this ).prop("tagName")!='DIV'){
      dato=dato+$( this ).val()+'|';
      }
    });
    dato=dato+'*';
  });
  $(campo).val(dato);
}

function _addTr(i,dato){
  var funcion=modalista['addTr'];
  eval(funcion+'('+i+',dato);');
}

function addTrListalista(i,dato){
$('#tablalista tbody').append('<tr id="trlista'+i+'" data-i="'+i+'">'+
  '<td><input id="valor'+i+'" type="text" class="validate dato'+i+'" value="'+dato[0]+'"></td>'+
  '<td><input id="texto'+i+'" type="text" class="validate dato'+i+'" value="'+dato[1]+'"></td>'+
  '<td><input id="tag'+i+'" type="text" class="validate dato'+i+'" value="'+dato[2]+'"></td>'+
  '<td> <i class="material-icons red-text" data-i="'+i+'" onclick="cDel('+i+');" style="cursor: pointer;" >delete</i> <i class="material-icons handle grey-text text-lighten-1 "  style="cursor: move;" >import_export</i> </td>'+
  '</tr>');
}

function getOptions(lista,sel){
var r='';
  for(var i in lista){
    var s='';
    if (sel!=''){
      if (sel==i){
        s=' selected="selected" ';
      }
    }
    r=r+'<option value="'+i+'" '+s+'>'+lista[i]+'</option>';
  }  
return r;
}

function addTrListaeventos(i,dato){
var listaopciones=[];
listaopciones['onchange']='onChange';
listaopciones['onclick']='onClick';
listaopciones['onblur']='onBlur';
listaopciones['onfocus']='onFocus';
var lista=getOptions(listaopciones,dato[0]);
$('#tablalista tbody').append('<tr id="trlista'+i+'" data-i="'+i+'">'+
  '<td><select  id="evento'+i+'" type="text" class="validate dato'+i+'" >'+lista+'</select></td>'+
  '<td><input id="codigo'+i+'" type="text" class="validate dato'+i+'" value="'+dato[1]+'"></td>'+
  '<td> <i class="material-icons red-text" data-i="'+i+'" onclick="cDel('+i+');" style="cursor: pointer;" >delete</i> <i class="material-icons handle grey-text text-lighten-1 "  style="cursor: move;" >import_export</i> </td>'+
  '</tr>');
  $('select').material_select();
}



function closeLista(){
  var modal=modalista['modal'];
  //var id=$(modal).attr('data-key');
  cSaveLista();
  Materialize.updateTextFields();
  $(modal).modal('close');
}


{% /append %}

{% var menunavigation=1 %}


<!-- <h2 class="header">   Tabla: <span class="grey-text text-lighten-4">{% echo $database.'.' %}</span>{% echo $tableName %}</h2> -->



<ul id="nav-mobile" class="side-nav" >
  <li><div class="divider"></div></li>
  <li><a class="subheader">{% echo strtoupper($tableName) %}</a></li>
  <li><div class="divider"></div></li>
  <li class="no-padding">
   <ul class="collapsible" data-collapsible="expandable">

    {% foreach $field in $_table %}

    <li >
      <div class="collapsible-header waves-effect {% if ($field['key']=='PRI')%}red-text{% /if %} "><i class="tiny material-icons ">{% if ($field['key']=='PRI')%}stars{% /if %}{% if ($field['key']=='MUL')%}vpn_key{% /if %}{% if ($field['key']=='')%}adjust{% /if %}</i>{% echo $field_i; %}</div>
      <div class="collapsible-body">
        <p>
          Tipo:{% echo $field['type']; %} {% if ($field['args'][0]) %} ( {% echo $field['args'][0] %} {% if ($field['args'][1]) %} , {% echo $field['args'][1] %} {% /if %} ) {% /if %}
          {% if ($field['null']=='NO') %} <br>Null: NO  {% /if %}
          {% if ($field['default']!='') %} <br>Default: {% echo $field['default'] %}   {% /if %}
          {% if ($field['extra']!='') %} <br>{% echo $field['extra'] %}   {% /if %}
        </p>
      </div>
    </li>
    {% /foreach %}
  </ul>        

</li>
</ul>


<form action="index.php?crud=generar" id="form1" name="fom1" method="post">
<div class="row">
  <div class="col s12">
    <ul class="tabs z-depth-1"">
      <li class="tab col s4"><a class="active" href="#tabcampos">CAMPOS</a></li>
      <li class="tab col s4"><a  class="" href="#listas">LISTA</a></li>
      <li class="tab col s4 "><a  class="" href="#formulario">FORMUARIO</a></li>
    </ul>
  </div>
  <div   id="tabcampos" class="col s12">

   <div class="input-field col s6">
          <input id="singular" name='singular' type="text" class="validate plantilla " data-type="text" value="{% echo $tableName %}">
          <label for="singular" data-error="Debe escribir un nombre en singular" data-success="">Nombre del Modulo en Singular</label>
   </div>
   <div class="input-field col s6">
          <input id="plural" name='plural' type="text" class="validate plantilla" data-type="text"  value="{% echo \Mk\Tools\String::Pluralize($tableName); %}" >
          <label for="plural" data-error="Debe escribir un nombre en plural" data-success="">Nombre del Modulo en plural</label>
   </div>
 
    {% include campos.html %}
   
  </div>
  <div id="listas" class="col s12">Lista</div>
  <div id="formulario" class="col s12">Formulario</div>
</div>

 </form>
 
 <!-- Modal Structure -->

  <div id="modal1" data-key="" class="modal modal-fixed-footer">
   <h4 id="modal-tit" style="border-bottom: 1px solid rgba(0, 0, 0, 0.1);background-color: #fafafa;border-radius:  2px 2px 0 0;height: 56px;position: absolute;top: 0;padding: 4px 6px;width: 100%;">Modal Header</h4>
    <div class="modal-content" style="margin-top:56px;height:calc(100% - 112px);">
      <div class="row">

       
  {% foreach $pedir in $_pedir %}
    
    {% php $ctam='s12'; if ($pedir['tam']!=''){$ctam=$pedir['tam'];} %}
    {% if ($pedir['type']=='text') %}

    

        <div class="input-field col {% echo $ctam; %} {% echo $pedir_i; %}">
        {% if ($pedir['icon']!='') %}        
        <i class="material-icons {% echo $pedir['icon-type'];%}" >{% echo $pedir['icon'];%}</i>
        {% /if %}
          <input id="{% echo $pedir_i; %}" name='{% echo $pedir_i; %}' type="text" class="validate _pedir" data-type="{% echo $pedir['type']; %}" {% echo $pedir['disabled']; %} {% echo $pedir['bind']; %} >
          <label for="{% echo $pedir_i; %}" data-error="{% echo $pedir['error']; %}" data-success="{% echo $pedir['ok']; %}">{% echo $pedir['text']; %}</label>
        </div>

    {% /if %}

     {% if ($pedir['type']=='int') %}

        <div class="input-field col {% echo $ctam; %} {% echo $pedir_i; %}">
        {% if ($pedir['icon']!='') %}        
        <i class="material-icons {% echo $pedir['icon-type'];%}" >{% echo $pedir['icon'];%}</i>
        {% /if %}
          <input id="{% echo $pedir_i; %}" name='{% echo $pedir_i; %}' type="number" class="validate _pedir" data-type="{% echo $pedir['type']; %}" {% echo $pedir['disabled']; %} {% echo $pedir['bind']; %}  {% if ($pedir['min']!='') %} min="{% echo $pedir['min']; %}" {% /if %} {% if ($pedir['max']!='') %} max="{% echo $pedir['max']; %}" {% /if %} >
          <label for="{% echo $pedir_i; %}" data-error="{% echo $pedir['error']; %}" data-success="{% echo $pedir['ok']; %}">{% echo $pedir['text']; %}</label>
        </div>

    {% /if %}

    {% if ($pedir['type']=='sel') %}

  <div class="input-field col {% echo $ctam; %} {% echo $pedir_i; %}">
    <select id="{% echo $pedir_i; %}" name='{% echo $pedir_i; %}' class="validate _pedir" data-type="{% echo $pedir['type']; %}"  {% echo $pedir['disabled']; %} {% echo $pedir['bind']; %} >
      {% echo $pedir['opt']; %}
    </select>
    <label   for="{% echo $pedir_i; %}" data-error="{% echo $pedir['error']; %}" data-success="{% echo $pedir['ok']; %}">{% echo $pedir['text']; %}</label>
  </div>

    {% /if %}

    {% if ($pedir['type']=='range') %}

  <div class="input-field col {% echo $ctam; %} {% echo $pedir_i; %}">
    <p class="range-field">
      <input type="range" id="{% echo $pedir_i; %}" name='{% echo $pedir_i; %}' class="validate _pedir" data-type="{% echo $pedir['type']; %}"  min="{% echo $pedir['min']; %}" max="{% echo $pedir['max']; %}" {% echo $pedir['disabled']; %} {% echo $pedir['bind']; %} >
    </p>
    <label  for="{% echo $pedir_i; %}"  data-error="{% echo $pedir['error']; %}" data-success="{% echo $pedir['ok']; %}">{% echo $pedir['text']; %}</label>
  </div>

    {% /if %}

    {% if ($pedir['type']=='switch') %}

  <div class=" col {% echo $ctam; %} {% echo $pedir_i; %}">
  <label >{% echo $pedir['text']; %}</label>
    <div class="switch" onclick="clicChecked('{% echo $pedir_i; %}')" >
    <label>
      {% echo $pedir['off']; %}
      <input type="checkbox" id="{% echo $pedir_i; %}" name='{% echo $pedir_i; %}' class=" _pedir" data-type="{% echo $pedir['type']; %}" data-on="{% echo $pedir['onval']; %}" data-off="{% echo $pedir['offval']; %}"  {% echo $pedir['disabled']; %} {% echo $pedir['bind']; %} >
      <span class="lever"></span>
      {% echo $pedir['on']; %}
    </label>
  </div>
   
  </div>

    {% /if %}

    {% if ($pedir['type']=='check') %}

 <div class="col {% echo $ctam; %} {% echo $pedir_i; %}">
    <p onclick="clicChecked('{% echo $pedir_i; %}')">
      <input type="checkbox" id="{% echo $pedir_i; %}" name='{% echo $pedir_i; %}' class=" _pedir" data-type="{% echo $pedir['type']; %}" data-on="{% echo $pedir['onval']; %}" data-off="{% echo $pedir['offval']; %}" {% echo $pedir['disabled']; %} {% echo $pedir['bind']; %} />
      <label  for="{% echo $pedir_i; %}" >{% echo $pedir['text']; %}</label>
    </p>
  </div>
   
    {% /if %}

    {% if ($pedir['type']=='raw') %}
      {% echo $pedir['text']; %}
    {% /if %}


  {% /foreach %}

    </div>

   
    </div>
    <div class="modal-footer">
     <button class="modal-action  waves-effect waves-green btn-flat" onclick="closeDet();">Ok</button>
     
      
    </div>
  </div>
  
 <!-- Modal Structure -->
  <div id="modal2" data-key="" class="modal modal-fixed-footer">
    <div class="modal-content">
      <h4 id="modal-tit">Escojer Tabla y Campo</h4>
      

      <div class="row">


  <div class="input-field col {% echo $ctam; %}">
    <select id="n_table" name='n_table' class="validate" onchange="getCampos();"  >
    {% echo $_tablas; %}
    </select>
    <label   for="n_table" >Tabla:</label>
  </div>

    </div>

   
      <div class="row">


  <div class="input-field col {% echo $ctam; %}">
  
    <select id="n_col" name='n_col' class="validate"   >
    </select>
    <label   for="n_col" >Columna:</label>
  </div>

    </div>



    </div>
    <div class="modal-footer">
     <button class="modal-action  waves-effect waves-green btn-flat" onclick="closeJoin();">Ok</button>
      
    </div>
  </div>

   <!-- Modal Structure -->
  <div id="modalLista" data-key="" class="modal modal-fixed-footer">
    <div class="modal-content">
      <h4 id="modal-tit">Crear lista</h4>
<div class="row ">
<div class="col s10">
  
</div>

<div class="col s2">
  <div class="btn z-depth-2 waves-effect waves-light green" onclick="cAdd();" id="bAddLista" data-indice='-1' >Adicionar</div>
</div>
</div>


      <div class="row">



<table class="striped" id="tablalista">
        <thead>
          <tr>
              <th data-field="valor">valor</th>
              <th data-field="texto">texto</th>
              <th data-field="tag">tags</th>
              <th data-field="action">Accion</th>
          </tr>
        </thead>

        <tbody>
         

        </tbody>
      </table>


    </div>



    </div>
    <div class="modal-footer">
     <button class="modal-action  waves-effect waves-green btn-flat" onclick="closeLista();">Ok</button>
      
    </div>
  </div>




